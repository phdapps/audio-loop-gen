<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Play Local Audio Loop</title>
    <style>
      #audioFile {
        width: 480px;
      }
      #progressBar {
        width: 480px;
      }
    </style>
  </head>
  <body>
    <h2>Select and Play an Audio Loop</h2>

    <!-- File input for selecting an audio file -->
    <div>
      <div>
        <input
          title="Audio Player"
          type="file"
          id="audioFile"
          accept="audio/*"
        />
      </div>
      <div>
        <progress id="progressBar" value="0" max="100"></progress>
        <!-- Pause/Resume button -->
        <button id="pauseResumeBtn" disabled>Pause</button>
      </div>
    </div>
    <script>
      // Native audio player can't play seemless loops
      let audioCtx = null;
      let source = null;
      isPlaying = true;

      let animationFrameId = null;

      // JavaScript to handle file selection and playback
      document
        .getElementById("audioFile")
        .addEventListener("change", async function (event) {
          if (audioCtx === null) {
            audioCtx = new window.AudioContext();
          }
          const file = event.target.files[0];
          const fileUrl = URL.createObjectURL(file);
          const arrayBuffer = await fetch(fileUrl).then((res) =>
            res.arrayBuffer()
          );
          // Convert ArrayBuffer to an AudioBuffer
          const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
          if (source !== null) {
            source.stop();
            source.disconnect(audioCtx.destination);
          }
          source = audioCtx.createBufferSource();
          source.buffer = audioBuffer;
          source.loop = true;
          source.connect(audioCtx.destination);
          source.start();
          isPlaying = true;
		  document.getElementById('pauseResumeBtn').disabled = false;
          updateProgressBar(audioBuffer.duration);
        });

      // Pause/Resume functionality
      document
        .getElementById("pauseResumeBtn")
        .addEventListener("click", function () {
          if (audioCtx !== null) {
            if (isPlaying) {
              audioCtx.suspend();
              this.textContent = "Resume";
            } else {
              audioCtx.resume();
              this.textContent = "Pause";
            }
            isPlaying = !isPlaying;
          }
        });

      function updateProgressBar(duration) {
        const progressBar = document.getElementById("progressBar");
        function update() {
          if (!source) return;
          const playTime = audioCtx.currentTime - source.startTime;
          const progress = (playTime / duration) * 100;
          progressBar.value = progress % 100; // Reset progress on loop
          animationFrameId = requestAnimationFrame(update);
        }
        source.startTime = audioCtx.currentTime;
        animationFrameId = requestAnimationFrame(update);
      }
    </script>
  </body>
</html>
